@page "/weather"
@using System.Net.Http.Headers
@using BlazorWhoknowsV2.Provider
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [AllowAnonymous]

<h3>Weather Forecast</h3>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

<EditForm Model="weatherRequest" OnValidSubmit="HandleWeatherRequest" FormName="this">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="location">Location</label>
        <InputText id="location" class="form-control" @bind-Value="weatherRequest.Location" />
    </div>

    <button type="submit" class="btn btn-primary">Get Weather</button>
</EditForm>

@if (weatherResponse != null)
{
    <h4>Weather Results</h4>
    <p><strong>Location:</strong> @weatherResponse.Location</p>
    <p><strong>Temperature:</strong> @weatherResponse.Temperature</p>
    <p><strong>Condition:</strong> @weatherResponse.Condition</p>
}

@code {
    private WeatherRequest weatherRequest = new WeatherRequest();
    private WeatherResponse weatherResponse;
    private string ErrorMessage;

    private async Task HandleWeatherRequest()
    {
        try
        {
            var response = await HttpClient.PostAsJsonAsync("https://localhost:7100/api/weather", weatherRequest);

            if (response.IsSuccessStatusCode)
            {
                weatherResponse = await response.Content.ReadFromJsonAsync<WeatherResponse>();
                ErrorMessage = null; // Clear previous error message
            }
            else
            {
                ErrorMessage = "Failed to retrieve weather data. Please try again.";
                weatherResponse = null; // Clear previous weather data
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "An error occurred while fetching the weather data.";
            weatherResponse = null; // Clear previous weather data
        }
    }

    private class WeatherRequest
    {
        public string Location { get; set; }
    }

    private class WeatherResponse
    {
        public string Location { get; set; }
        public string Temperature { get; set; }
        public string Condition { get; set; }
    }
}
